<html lang="en">
<style>
    .chat-content {
        height: 450px;
        overflow-y: scroll;
        padding: 10px;
    }
    .chat-content li {
        margin-top: 10px;
        list-style: none;
    }
    .text-small {
        font-size: 12px;
        color: gray;
        margin-bottom: 0;
    }
    .chat-box {
        background: #eee;
        padding: 5px;
        border-radius: 5px;
        float: left;
    }
    .mine {
        float: right;
    } 
</style>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <%- include( './component/header.ejs' ) %>
    <div class="container p-4 detail">
        <div class="row">
          <div class="col-3">
            <ul class="list-group chat-list">
              <li class="list-group-item" data-id="">
                <h6>채팅방1</h6>
                <h6 class="text-small">채팅방설명</h6>
              </li>
              <li class="list-group-item">
                 <h6>채팅방2</h6>
                 <h6 class="text-small">채팅방설명</h6>
               </li>
             </ul>
           </div>
      
           <div class="col-9 p-0">
             <div class="chat-room">
                <ul class="list-group chat-content">
                  <% if( msgInfos.length > 0 ) { %>
                    <% msgInfos.forEach( msg => { %>
                      <% if( msg.sender != user.username ) { %>
                        <li><span class="chat-box"><%= msg.message %></span></li>
                      <% } else { %>
                        <li><span class="chat-box mine"><%= msg.message %></span></li>
                      <% } %>
                    <% } ); %>
                  <% } else { %>
                    <h6>채팅 내역이 없습니다.</h6>
                  <% } %>
                </ul>
              <div class="input-group">
                <input class="form-control" id="chat-input" onkeypress="msgEnterCheck( $( '#chat-input' ).val() )">
                <button class="btn btn-secondary" id="send" onclick="sendMessage( $( '#chat-input' ).val(), `<%= user.username %>`, `<%= chatInfos._id %>` )" disabled>전송</button>
              </div>
            </div>
          </div>
        </div>
      </div>
</body>
<script>


    $( document ).ready( () => {
      this.addEventListener( 'keypress', ( e ) => {
        if ( e.key === 'Enter' ) {
          sendMessage( $( '#chat-input' ).val(), `<%= user.username %>`, `<%= chatInfos._id %>` );
        }
      });
    } );

  const msgEnterCheck = ( msgInput ) => {
    if( msgInput.length > 0 ) {
      $( "#send" ).attr( "disabled", false );
    } else {
      $( "#send" ).attr( "disabled", true );
    }
  }

  const sendMessage = ( msg, sender, chatNo ) => {
    $.ajax(
      {
        method : "post",
        url    : "/post/sendMsg",
        data   : {
          chatInfos : chatNo,
          message : msg,
          sender : sender,
          sendDate : new Date()
        },
        success : ( res ) => {
          location.reload();
        },
        fail : ( err ) => {
          console.log(err);
        }
      }
    )
  }
</script>
</html>